name: NIST PQC Compliance Validation

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  nist-pqc-validation:
    name: NIST PQC Compliance Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python -c "import sys; print(sys.version)"

    - name: Install package in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run NIST PQC hybrid key generation tests
      run: |
        python -m unittest test_nist_pqc -v

    - name: Run NIST PQC test vector compliance tests
      run: |
        python -m unittest test_nist_pqc_vectors -v

    - name: Validate Kyber algorithm compliance
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key, get_algorithm_info
        
        # Test all Kyber variants
        for alg in [PQCAlgorithm.KYBER512, PQCAlgorithm.KYBER768, PQCAlgorithm.KYBER1024]:
            info = get_algorithm_info(alg)
            det_key, pqc_seed = generate_hybrid_key(alg)
            assert len(det_key) == 16, f'{alg.value}: Wrong deterministic key length'
            assert len(pqc_seed) == 32, f'{alg.value}: Wrong PQC seed length'
            print(f'✓ {alg.value} compliant: {len(pqc_seed)} byte seed, security level {info[\"security_level\"]}')
        "

    - name: Validate Dilithium algorithm compliance
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key, get_algorithm_info
        
        # Test all Dilithium variants
        for alg in [PQCAlgorithm.DILITHIUM2, PQCAlgorithm.DILITHIUM3, PQCAlgorithm.DILITHIUM5]:
            info = get_algorithm_info(alg)
            det_key, pqc_seed = generate_hybrid_key(alg)
            assert len(det_key) == 16, f'{alg.value}: Wrong deterministic key length'
            assert len(pqc_seed) == 32, f'{alg.value}: Wrong PQC seed length'
            print(f'✓ {alg.value} compliant: {len(pqc_seed)} byte seed, security level {info[\"security_level\"]}')
        "

    - name: Validate SPHINCS+ algorithm compliance
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key, get_algorithm_info
        
        # Test all SPHINCS+ variants
        variants = [
            (PQCAlgorithm.SPHINCS_PLUS_128F, 48),
            (PQCAlgorithm.SPHINCS_PLUS_192F, 64),
            (PQCAlgorithm.SPHINCS_PLUS_256F, 64)
        ]
        for alg, expected_seed_len in variants:
            info = get_algorithm_info(alg)
            det_key, pqc_seed = generate_hybrid_key(alg)
            assert len(det_key) == 16, f'{alg.value}: Wrong deterministic key length'
            assert len(pqc_seed) == expected_seed_len, f'{alg.value}: Wrong PQC seed length'
            print(f'✓ {alg.value} compliant: {len(pqc_seed)} byte seed, security level {info[\"security_level\"]}')
        "

    - name: Validate entropy quality of generated seeds
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key, validate_pqc_seed_entropy
        
        algorithms = [
            PQCAlgorithm.KYBER768,
            PQCAlgorithm.DILITHIUM3,
            PQCAlgorithm.SPHINCS_PLUS_128F
        ]
        
        for alg in algorithms:
            _, pqc_seed = generate_hybrid_key(alg)
            metrics = validate_pqc_seed_entropy(pqc_seed)
            
            assert metrics['passes_basic_checks'], f'{alg.value} failed entropy checks'
            print(f'✓ {alg.value} entropy: {metrics[\"shannon_entropy\"]:.2f} bits/byte, diversity: {metrics[\"byte_diversity\"]:.2f}')
        "

    - name: Validate hybrid key determinism
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key
        
        # Generate same key twice and verify determinism
        det_key1, pqc_seed1 = generate_hybrid_key(PQCAlgorithm.KYBER768, context=b'TEST')
        det_key2, pqc_seed2 = generate_hybrid_key(PQCAlgorithm.KYBER768, context=b'TEST')
        
        assert det_key1 == det_key2, 'Deterministic keys do not match'
        assert pqc_seed1 == pqc_seed2, 'PQC seeds do not match'
        print('✓ Hybrid key generation is deterministic')
        print(f'  Deterministic key: {det_key1.hex()[:32]}...')
        print(f'  PQC seed: {pqc_seed1.hex()[:32]}...')
        "

    - name: Validate context binding
      run: |
        python -c "
        from gq.nist_pqc import PQCAlgorithm, generate_hybrid_key
        
        # Generate keys with different contexts
        _, seed_a = generate_hybrid_key(PQCAlgorithm.KYBER768, context=b'CONTEXT_A')
        _, seed_b = generate_hybrid_key(PQCAlgorithm.KYBER768, context=b'CONTEXT_B')
        
        assert seed_a != seed_b, 'Different contexts should produce different seeds'
        print('✓ Context binding verified')
        print(f'  Context A seed: {seed_a.hex()[:32]}...')
        print(f'  Context B seed: {seed_b.hex()[:32]}...')
        "

    - name: Generate compliance report
      run: |
        python -c "
        import json
        from gq.nist_pqc import PQCAlgorithm, get_algorithm_info
        
        report = {
            'nist_pqc_compliance': 'PASS',
            'algorithms_tested': [],
            'standards': {
                'kyber': 'NIST FIPS 203 - ML-KEM',
                'dilithium': 'NIST FIPS 204 - ML-DSA',
                'sphincs': 'NIST FIPS 205 - SLH-DSA'
            }
        }
        
        for alg in PQCAlgorithm:
            info = get_algorithm_info(alg)
            report['algorithms_tested'].append({
                'algorithm': alg.value,
                'type': info['type'],
                'security_level': info['security_level'],
                'seed_length': info['seed_length']
            })
        
        print('\\n' + '='*60)
        print('NIST PQC COMPLIANCE REPORT')
        print('='*60)
        print(json.dumps(report, indent=2))
        print('='*60)
        print('\\n✓ All NIST PQC compliance tests passed')
        "

  integration-test:
    name: Integration Test with Existing Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run all test suites
      run: |
        echo "Running GQS-1 tests..."
        python -m unittest test_gqs1 -v
        
        echo "Running Universal QKD tests..."
        python -m unittest test_universal_qkd -v
        
        echo "Running NIST PQC tests..."
        python -m unittest test_nist_pqc -v
        
        echo "Running NIST PQC vector tests..."
        python -m unittest test_nist_pqc_vectors -v
        
        echo "✓ All test suites passed"

    - name: Verify package exports
      run: |
        python -c "
        # Test that main exports are available
        from gq import (
            UniversalQKD,
            GQS1,
            GOLDEN_RATIO,
            PI,
            E,
            SQRT2,
        )
        
        # Test that NIST PQC module can be imported directly
        from gq.nist_pqc import (
            PQCAlgorithm,
            PQCSecurityLevel,
            generate_hybrid_key,
            generate_hybrid_key_stream,
            generate_kyber_seed,
            generate_dilithium_seed,
            generate_sphincs_seed,
            validate_pqc_seed_entropy,
            get_algorithm_info,
        )
        print('✓ All exports available')
        print('✓ Package API is complete')
        print('✓ NIST PQC functions accessible via gq.nist_pqc module')
        "
