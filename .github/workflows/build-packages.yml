name: Build and Test Packages

on:
  push:
    branches: [ main, develop, copilot/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-python:
    name: Build Python Package
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Display Python version
      run: python -c "import sys; print(sys.version)"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: python -m build
    
    - name: Check package
      run: twine check dist/*
    
    - name: Install package
      run: pip install -e .
    
    - name: Verify installation
      run: |
        python -c "import gq; print(f'GoldenSeed version {gq.__version__}')"
        python -c "from gq import UniversalQKD; print('Stream:', next(UniversalQKD()).hex())"
    
    - name: Test CLI commands
      run: |
        gq-universal --help
        gq-test-vectors --help
        gq-coin-flip --help
    
    - name: Run unit tests
      run: python -m unittest discover -v -s . -p "test_*.py"
      continue-on-error: true
    
    - name: Upload artifacts
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: actions/upload-artifact@v6
      with:
        name: python-packages
        path: dist/*

  build-javascript:
    name: Build JavaScript Package
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['14', '16', '18', '20']
        exclude:
          # Node.js 14 is not available for macOS arm64
          - os: macos-latest
            node-version: '14'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Display Node.js version
      run: node --version
    
    - name: Build JavaScript package
      run: node build-js.js
    
    - name: Test JavaScript package
      run: |
        node -e "const gs = require('./dist/index.js'); console.log('PHI:', gs.PHI);"
        node -e "const gs = require('./dist/index.js'); console.log('Sequence:', gs.goldenRatioSequence(0, 3));"
        node -e "const gs = require('./dist/index.js'); console.log('Test vectors:', gs.generateTestVectors(2));"
    
    - name: Upload artifacts
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '18'
      uses: actions/upload-artifact@v6
      with:
        name: javascript-packages
        path: dist/*.js

  test-installation-scripts:
    name: Test Installation Scripts
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Test Unix installation script
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x install.sh
        ./install.sh
    
    - name: Test Windows installation script
      if: matrix.os == 'windows-latest'
      run: |
        ./install.bat
      shell: cmd
    
    - name: Verify installation
      run: |
        python -c "import gq; print(f'Version: {gq.__version__}')"

  package-quality:
    name: Package Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine check-manifest
    
    - name: Build package
      run: python -m build
    
    - name: Check package quality
      run: |
        twine check dist/*
        check-manifest --ignore 'dist/*,*.egg-info/*,build/*' || true
    
    - name: Check package metadata
      run: |
        python -m pip install dist/*.whl
        python -c "import gq; import pkg_resources; print('Package info:', pkg_resources.get_distribution('golden-seed'))"
