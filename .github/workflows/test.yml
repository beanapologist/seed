name: GoldenSeed Tests

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python -c "import sys; print(sys.version)"

    - name: Install package in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install test dependencies
      run: |
        pip install pytest

    - name: Run all tests
      run: |
        python -m pytest tests/ -v

    - name: Verify first stream matches specification
      run: |
        FIRST_KEY=$(python -c "from gq import generate_universal_keys; print(generate_universal_keys(1)[0])")
        EXPECTED="3c732e0d04dac163a5cc2b15c7caf42c"
        if [ "$FIRST_KEY" != "$EXPECTED" ]; then
          echo "ERROR: First stream mismatch!"
          echo "Expected: $EXPECTED"
          echo "Got: $FIRST_KEY"
          exit 1
        fi
        echo "✓ First stream validated: $FIRST_KEY"

    - name: Verify GQS-1 first vector matches specification
      run: |
        FIRST_VECTOR=$(python -c "from gq import generate_gqs1_vectors; print(generate_gqs1_vectors(1)[0])")
        EXPECTED="a01611f01e8207a27c1529c3650c4838"
        if [ "$FIRST_VECTOR" != "$EXPECTED" ]; then
          echo "ERROR: GQS-1 first vector mismatch!"
          echo "Expected: $EXPECTED"
          echo "Got: $FIRST_VECTOR"
          exit 1
        fi
        echo "✓ GQS-1 first vector validated: $FIRST_VECTOR"

    - name: Cross-validate test vectors
      run: |
        python -c "
        import json
        from gq import generate_universal_keys, generate_gqs1_vectors

        # Load reference vectors
        with open('tests/test_vectors.json', 'r') as f:
            reference = json.load(f)

        # Generate streams and compare
        universal_keys = generate_universal_keys(10)
        gqs1_keys = generate_gqs1_vectors(10)

        assert universal_keys == reference['protocols']['GCP-1']['test_vectors'], 'Universal stream vectors mismatch'
        assert gqs1_keys == reference['protocols']['GQS-1']['test_vectors'], 'GQS-1 vectors mismatch'

        print('✓ All test vectors validated against reference')
        print(f'  Universal streams: {len(universal_keys)} verified')
        print(f'  GQS-1: {len(gqs1_keys)} vectors verified')
        "

    - name: Verify CLI entry points
      run: |
        which gq-universal || echo "Warning: gq-universal not in PATH (expected for editable install)"
        which gq-test-vectors || echo "Warning: gq-test-vectors not in PATH (expected for editable install)"
        python -m gq.cli.universal --help
        python -m gq.cli.gqs1 --help

    - name: Test package import
      run: |
        python -c "
        from gq import UniversalQKD, GQS1, HEX_SEED, EXPECTED_CHECKSUM
        print('✓ Package imports successful')
        print(f'  Seed: {HEX_SEED[:32]}...')
        print(f'  Checksum: {EXPECTED_CHECKSUM[:32]}...')

        # Test UniversalQKD
        gen = UniversalQKD()
        key = next(gen)
        print(f'✓ UniversalQKD generator working: {key.hex()[:32]}...')

        # Test GQS1
        vectors = GQS1.generate_test_vectors(1)
        print(f'✓ GQS1 generator working: {vectors[0][:32]}...')
        "

    - name: Verify zero dependencies
      run: |
        pip list --format=freeze | grep -v "^golden-seed" | grep -v "^pip" | grep -v "^setuptools" | wc -l | grep "^0$" || \
        echo "Note: Dev environment may have additional packages"

  security:
    name: Security and Code Quality
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Verify package installation
      run: |
        python -c "from gq import UniversalQKD, GQS1; print('✓ Package imports successful')"

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov

    - name: Run tests with coverage
      run: |
        python -m pytest tests/ --cov=src/gq --cov-report=term-missing --cov-report=xml

    - name: Display coverage summary
      run: |
        echo "Test suite completed successfully"

  scalability:
    name: Scalability and Performance Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest

    - name: Run compression capacity tests
      run: |
        python -m pytest tests/test_compression_capacity.py -v

  extreme-tests:
    name: Edge Cases and Additional Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest

    - name: Run edge cases tests
      run: |
        python -m pytest tests/test_edge_cases.py -v

    - name: Run watermark tests
      run: |
        python -m pytest tests/test_watermark.py tests/test_watermark_integration.py -v

    - name: Run golden ratio coin flip tests
      run: |
        python -m pytest tests/test_golden_ratio_coin_flip.py -v
